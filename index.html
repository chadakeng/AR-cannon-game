<!DOCTYPE html>
<html>
<head>
  <title>AR Cannon Game</title>
  <meta charset="utf-8" />
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <script>
    AFRAME.registerComponent('hit-feedback', {
      init: function () {
        this.el.setAttribute('visible', false);
        this.el.addEventListener('hit', () => {
          this.showFeedback();
        });
      },
      showFeedback: function() {
        this.el.setAttribute('visible', true);
        setTimeout(() => {
          this.el.setAttribute('visible', false);
        }, 1000);
      }
    });

    AFRAME.registerComponent('countdown-manager', {
      init: function () {
        this.isGreenTurn = true;
        this.countdown = 5;
        this.isRunning = true;

        this.greenText = document.querySelector('#greenTimer');
        this.blueText = document.querySelector('#blueTimer');
        this.greenBall = document.querySelector('#greenBall');
        this.blueBall = document.querySelector('#blueBall');
        this.greenCannon = document.querySelector('#greenCannon');
        this.blueCannon = document.querySelector('#blueCannon');
        this.greenTarget = document.querySelector('#greenTarget');
        this.blueTarget = document.querySelector('#blueTarget');

        this.greenMarker = document.querySelector('#greenMarker');
        this.blueMarker = document.querySelector('#blueMarker');
        this.startCountdown();
      },

      startCountdown: function () {  
        this.countdown = 5;
        const timer = setInterval(() => {
          if (!this.isRunning) {
            clearInterval(timer);
            return;
          }

          if (this.isGreenTurn) {
            this.greenText.setAttribute('value', this.countdown.toString());
            this.blueText.setAttribute('value', '');
          } else {
            this.blueText.setAttribute('value', this.countdown.toString());
            this.greenText.setAttribute('value', '');
          }

          this.countdown--;

          if (this.countdown < 0) {
            clearInterval(timer);
            // If paused mid-countdown
            if (!this.isRunning) return;

            this.fireCannonBall(
              this.isGreenTurn ? this.greenBall : this.blueBall,
              this.isGreenTurn ? this.greenCannon : this.blueCannon
            );

            setTimeout(() => {
              if (!this.isRunning) return;
              this.isGreenTurn = !this.isGreenTurn;
              this.startCountdown(); // Start next round after firing sequence completes
            }, 500);
          }
        }, 1000);
      },

      fireCannonBall: function (ball, cannon) {
        ball.setAttribute('visible', 'true');

        // Ensure transformations are up to date
        this.el.sceneEl.object3D.updateMatrixWorld(true);

        // Original start position logic (unchanged)
        const cannonPos = cannon.object3D.position;
        const startPos = {
          x: cannonPos.x,
          y: cannonPos.y + 0.2,
          z: cannonPos.z + 0.9,
        };

        ball.setAttribute('position', startPos);

        let time = 0;

        // Simulate projectile motion (parabolic arc)
        const interval = setInterval(() => {
          this.el.sceneEl.object3D.updateMatrixWorld(true); // Update before reading positions

          time += 0.05;

          const gravity = 9.8; // Gravity
          const forwardVelocity = 2; 
          const upwardVelocity = 5; 

          const newX = startPos.x;
          const newY = startPos.y + upwardVelocity * time - 0.5 * gravity * time * time;
          const newZ = startPos.z + forwardVelocity * time;

          ball.setAttribute('position', { x: newX, y: newY, z: newZ });

          // Check if ball hits ground
          if (newY <= 0) {
            clearInterval(interval);
            ball.setAttribute('visible', 'false');
            ball.setAttribute('position', { x: 0, y: 0.2, z: 0 });
            return;
          }

          // Get world position of the ball
          const ballWorldPos = new THREE.Vector3();
          ball.object3D.getWorldPosition(ballWorldPos);

          // Check collision with targets
          const targets = document.querySelectorAll('.target');
          targets.forEach(target => {
            const targetWorldPos = new THREE.Vector3();
            target.object3D.getWorldPosition(targetWorldPos);

            const distance = ballWorldPos.distanceTo(targetWorldPos);
            // Adjust threshold as needed
            if (distance <= 0.5) {
              // Trigger hit event
              target.emit('hit');

              clearInterval(interval);
              ball.setAttribute('visible', 'false');
              ball.setAttribute('position', { x: 0, y: 0.2, z: 0 });
            }
          });
        }, 50);
      }
    });

    AFRAME.registerComponent('health-system', {
      schema: {
        health: { type: 'int', default: 3 }
      },
      init: function () {
        this.health = this.data.health;
        this.healthText = document.createElement('a-entity');
        this.healthText.setAttribute('text', {
          value: `Health: ${this.health}`,
          color: 'red',
          align: 'center',
          width: 4
        });
        this.healthText.setAttribute('position', '0 2 0');
        this.el.appendChild(this.healthText);
    
        this.el.addEventListener('hit', () => {
          this.deductHealth();

          // Determine if this is green or blue and show the corresponding red feedback plane
          const isGreen = this.el.id.includes('green');
          const redFeedback = isGreen ? document.querySelector('#greenHitPlane') : document.querySelector('#blueHitPlane');
          if (redFeedback) {
            redFeedback.setAttribute('visible', true);
            setTimeout(() => {
              redFeedback.setAttribute('visible', false);
            }, 1000);
          }
        });
    
        this.el.addEventListener('game-over', () => {
          this.showGameOver();
        });
      },
      deductHealth: function () {
        this.health--;
        this.healthText.setAttribute('text', 'value', `Health: ${this.health}`);
        if (this.health <= 0) {
          this.el.emit('game-over');
        }
      },
      showGameOver: function() {
        const isGreen = this.el.id.includes('green');
        const message = isGreen ? "You Won!" : "You Lost!";
        this.healthText.setAttribute('text', 'value', message);
      }
    });

    AFRAME.registerComponent('collision-check', {
      schema: {
        targetSelector: { type: 'string', default: '.target' },
        threshold: { type: 'number', default: 0.5 } // Collision distance
      },
      tick: function () {
        const ballPos = this.el.object3D.position;
        const targets = document.querySelectorAll(this.data.targetSelector);
        targets.forEach((target) => {
          const targetPos = target.object3D.position;
          const distance = ballPos.distanceTo(targetPos);
          if (distance <= this.data.threshold) {
            target.emit('hit');
            this.el.setAttribute('visible', false); // Hide ball on hit
          }
        });
      }
    });
  </script>
  <script src="components/hit-feedback.js"></script>
  <script src="components/health-system.js"></script>
  <script src="components/sound-manager.js"></script>
  <script src="components/countdown-manager.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
  <a-scene embedded
    vr-mode-ui="enabled: false"
    arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3_PARITY65">

    <a-assets>
      <a-asset-item id="cannonModel" src="assets/cannon.glb"></a-asset-item>
      <img id="cannonImgGreen" src="assets/cannon_green.jpg">
      <img id="cannonImgBlue" src="assets/cannon_blue.jpg">
      <audio id="background" src="assets/background.mp3" preload="auto"></audio>
    </a-assets>

    <!-- Background sound -->
    <a-sound src="#background" autoplay="true" loop="true"></a-sound>

    <a-entity countdown-manager></a-entity>

    <!-- Green Marker -->
    <a-marker type="barcode" value="0" id="greenMarker">
      <a-text
        id="greenTimer"
        position="0 0 -1"
        rotation="-90 180 0"
        align="center"
        color="#0f0"
        scale="2 2 2"
        value="">
      </a-text>

      <a-plane
        src="#cannonImgGreen"
        rotation="-90 -180 0"
        position="0 -0.1 0"
        width="1"
        height="1">
      </a-plane>

      <!-- Red Feedback Plane for Green side -->
      <a-plane
        id="greenHitPlane"
        position="0 -0.11 0"
        rotation="-90 -180 0"
        width="1.1"
        height="1.1"
        material="color: red; opacity:0.5"
        visible="false"
        hit-feedback>
      </a-plane>

      <a-entity
        id="greenCannon"
        gltf-model="#cannonModel"
        position="0 0 0"
        rotation="0 -90 0"
        scale="0.8 0.8 0.8"
        health-system
        sound-manager>

        <!-- Green Ball (child of greenCannon) -->
        <a-entity
          id="greenBall"
          geometry="primitive: sphere; radius: 0.2"
          material="color: green"
          visible="false"
          position="0 0.15 0.5">
        </a-entity>
      </a-entity>

      <a-entity
        id="greenTarget"
        class="target"
        position="0 0 -10"
        scale="0.1 0.1 0.1"
        geometry="primitive: box"
        material="color: green; opacity: 0; transparent: true">
      </a-entity>
    </a-marker>

    <!-- Blue Marker -->
    <a-marker type="barcode" value="6" id="blueMarker">
      <a-text
        id="blueTimer"
        position="0 0 1"
        rotation="-90 180 180"
        align="center"
        color="#00f"
        scale="2 2 2"
        value="">
      </a-text>

      <a-plane
        src="#cannonImgBlue"
        rotation="-90 0 0"
        position="0 -0.1 0"
        width="1"
        height="1">
      </a-plane>

      <!-- Red Feedback Plane for Blue side -->
      <a-plane
        id="blueHitPlane"
        position="0 -0.11 0"
        rotation="-90 0 0"
        width="1.1"
        height="1.1"
        material="color: red; opacity:0.5"
        visible="false"
        hit-feedback>
      </a-plane>

      <a-entity
        id="blueCannon"
        gltf-model="#cannonModel"
        position="0 0 0"
        rotation="0 -90 0"
        scale="0.8 0.8 0.8"
        health-system
        sound-manager>

        <!-- Blue Ball (child of blueCannon) -->
        <a-entity
          id="blueBall"
          geometry="primitive: sphere; radius: 0.2"
          material="color: blue"
          visible="false"
          position="0 0.15 -0.5">
        </a-entity>
      </a-entity>

      <a-entity
        id="blueTarget"
        class="target"
        position="0 0 -10"
        scale="0.1 0.1 0.1"
        geometry="primitive: box"
        material="color: blue; opacity: 0; transparent: true">
      </a-entity>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>
</body>
</html>
